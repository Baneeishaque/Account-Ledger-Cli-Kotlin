name: Gradle Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    name: 'Standardized Linting'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 1

      - name: 'Run ShellCheck'
        uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # 2.0.0
        with:
          scandir: './.github/scripts'

      - name: 'Run Actionlint'
        uses: reviewdog/action-actionlint@e58ee9d111489c31395fbe4857b0be6e7635dbda # v1
        with:
          fail_level: error

  build:
    name: 'Premium Gradle Build (JDK 21)'
    needs: lint
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Set up tools with mise
        uses: Baneeishaque/mise-setup-verification-action@bca6635be4dd23f8b7d4a408b8f4ee33fbfb1343
        with:
          mise_version: '2025.12.9'
          working_directory: '.'
          tool_name: 'java'
          version_command: 'java -version'
          install: 'true'
          cache: 'true'

      - name: Inject secret serverApiAddress
        run: |
          sed -i "s|http://localhost/http_API/|${{ secrets.SERVER_API_ADDRESS }}/http_API/|" account-ledger-lib/account-ledger-lib/src/main/kotlin/account/ledger/library/api/ApiConstants.kt
        shell: bash

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5
        with:
          gradle-version: 'wrapper'
          cache-cleanup: 'on-success'
          gradle-home-cache-includes: 'caches,notifications,wrapper'
          cache-encryption-key: ${{ secrets.GRADLE_CACHE_ENCRYPTION_KEY }}
          build-scan-publish: true
          build-scan-terms-of-use-url: 'https://gradle.com/terms-of-service'
          build-scan-terms-of-use-agree: 'yes'
          dependency-graph: generate-and-submit
          add-job-summary-as-pr-comment: 'always'
        continue-on-error: ${{ github.event_name == 'pull_request' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: 'Gradle Build : Tar Distribution'
        run: ./gradlew :cli-app:distTar --info

      - name: 'Rebuilding Tar Distribution'
        run: ./.github/scripts/rebuild-distribution.bash
        shell: bash

      - name: 'Upload Artifact'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: Account-Ledger-CLI
          path: cli-app/build/distributions/Account-Ledger-Cli.tar.gz
